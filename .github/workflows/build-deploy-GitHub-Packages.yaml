name: Build and Deploy AJAX Application - Nuget (GPR)
run-name: "Deploy to @${{ github.ref_name }} by @${{ github.actor }}"

on:
  release:
    types: [created]
    tags:
      - '*'

  workflow_dispatch:
    inputs:
      build_deploy_choice:
          description: 'Build, Deploy or Both'
          required: true
          default: 'build_deploy' 
          type: choice
          options:
          - build_only
          - deploy_only
          - build_deploy

jobs:
  build-and-publish:
    runs-on: windows-latest

    env:
      PROJECT_NAME: NetGitHubActions-POC
      PROJECT_RELEASES: ${{ github.GITHUB_WORKSPACE }}/releases
      NuGetDirectory: ${{ github.GITHUB_WORKSPACE }}/nuget

    if: ${{ github.ref_type == 'tag' }}
    steps:
      - name: Transform Tag
        run: |
          $tag = $env:GITHUB_REF.Replace("refs/tags/", "")
          $nuget_version = $tag -replace '^v(\d+\.\d+\.\d+)(-.+)?$', '$1$2'
          "NUGET_VERSION=$nuget_version" | Out-File -FilePath $env:GITHUB_ENV -Append
      - name: Print NuGet-Compatible Version
        run: echo "NuGet-Compatible Version:${{ env.NUGET_VERSION }}"

      - name: Checkout repository
        uses: actions/checkout@main
        
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1

      - name: Setup .NET Framework
        uses: actions/setup-dotnet@v1

      - name: Restore NuGet packages
        run: nuget restore ${{ env.PROJECT_NAME }}/${{ env.PROJECT_NAME }}.csproj -PackagesDirectory packages
        env:
          TELERIK_USERNAME: ${{ secrets.TELERIK_NUGET_USER }}
          TELERIK_PASSWORD: ${{ secrets.TELERIK_NUGET_KEY }}
          NUGET_USER: ${{ github.actor }}
          NUGET_API_KEY: ${{ secrets.GITHUB_TOKEN }}

      - name: Build the solution
        run: |
            msbuild ${{ env.PROJECT_NAME }}/${{ env.PROJECT_NAME }}.csproj /p:Configuration=Release
            msbuild ${{ env.PROJECT_NAME }}/${{ env.PROJECT_NAME }}.csproj /p:Configuration=Debug /p:DebugSymbols=true /p:DebugType=full
        env:
          PROJECT_DIR: ${{ env.PROJECT_NAME }}
          BUILD_CONFIG: Release

      - name: Create releases directory
        run: |
          mkdir releases
          mkdir nuget
        
      - name: Create NuGet package
        id: create-nuget-package
        run: |
            nuget pack ${{ env.PROJECT_NAME }}/${{ env.PROJECT_NAME }}.csproj -Prop Configuration=Release -Version ${{ env.NUGET_VERSION }} -Symbols -SymbolPackageFormat snupkg
            # Copy-Item -Path "$($env:PROJECT_NAME).$($env:NUGET_VERSION).nupkg" -Destination "$($env:GITHUB_WORKSPACE)/releases/$($env:PROJECT_NAME).$($env:NUGET_VERSION).nupkg"
            # Copy-Item -Path "$($env:PROJECT_NAME).$($env:NUGET_VERSION).snupkg" -Destination "$($env:GITHUB_WORKSPACE)/releases/$($env:PROJECT_NAME).$($env:NUGET_VERSION).snupkg"
            # Copy-Item -Path "$($env:PROJECT_NAME).$($env:NUGET_VERSION).nupkg" -Destination "$($env:GITHUB_WORKSPACE)/releases/$($env:PROJECT_NAME).$($env:NUGET_VERSION).symbols.nupkg"
            # Copy-Item -Path "$($env:PROJECT_NAME).$($env:NUGET_VERSION).snupkg" -Destination "$($env:GITHUB_WORKSPACE)/releases/$($env:PROJECT_NAME).$($env:NUGET_VERSION).symbols.snupkg"

            Get-ChildItem -Path "$($env:GITHUB_WORKSPACE)" -Include *.nupkg, *.snupkg -Recurse | ForEach-Object {
              ls -Path $_.FullName
            }

      # - name: Copy NuGet packages
      #   id: copy-nuget-package
      #   run: |
      #       Get-ChildItem -Path "${{ env.PROJECT_RELEASES }}" -Include *.nupkg,*.snupkg -Recurse | ForEach-Object { 
      #           Copy-Item -Path $_.FullName -Destination "${{ env.NuGetDirectory }}"
      #       }

      - name: List out PROJECT_RELEASES packages
        id: project-list-packages
        run: |
            echo "GITHUB_WORKSPACE: $($env:GITHUB_WORKSPACE)"
            echo "PROJECT_RELEASES: $($env:PROJECT_RELEASES)"
            echo "NuGetDirectory: $($env:NuGetDirectory)"

            ls  *.nupkg -Path "$($env:GITHUB_WORKSPACE)" -Recurse

            Get-ChildItem -Path "$($env:GITHUB_WORKSPACE)" -Include *.nupkg, *.snupkg -Recurse | ForEach-Object {
              ls -Path $_.FullName
            }
      # - name: List out NuGetDirectory packages
      #   if: always()
      #   id: nuget-list-packages
      #   run: |
      #       Get-ChildItem -Path "$($env:GITHUB_WORKSPACE)/nuget" -Include *.nupkg, *.snupkg -Recurse | ForEach-Object {
      #         ls -Path $_.FullName
      #       }
  #     - name: Upload Release NuGet package
  #       # if: github.event_name == 'release'
  #       id: upload-release-asset
  #       uses: actions/upload-release-asset@main
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #       with:
  #         upload_url: ${{ github.event.release.upload_url }}
  #         asset_path: ${{ env.PROJECT_NAME }}.${{ env.NUGET_VERSION }}.nupkg
  #         asset_name: ${{ env.PROJECT_NAME }}.${{ env.NUGET_VERSION }}.nupkg
  #         asset_content_type: application/zip

  #     - name: Upload Debug NuGet package
  #       # if: github.event_name == 'release'
  #       id: upload-debug-asset
  #       uses: actions/upload-release-asset@main
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #       with:
  #         upload_url: ${{ github.event.release.upload_url }}
  #         asset_path: ${{ env.PROJECT_NAME }}.${{ env.NUGET_VERSION }}.snupkg
  #         asset_name: ${{ env.PROJECT_NAME }}.${{ env.NUGET_VERSION }}.snupkg
  #         asset_content_type: application/zip
          
  #     - name: Copy Nuget packages to ${{ env.NuGetDirectory }}
  #       id: copy-items-nuget-directory
  #       run: |
  #         # Put to ${{ github.workspace}}/nuget
  #         Get-ChildItem -Path "$($env:GITHUB_WORKSPACE)/releases" -Include *.nupkg,*.snupkg -Recurse | ForEach-Object { 
  #             Copy-Item -Path $_.FullName -Destination ${{ env.NuGetDirectory}}
  #         }
  #     # Publish the NuGet package as an artifact, so they can be used in the following jobs
  #     - uses: actions/upload-artifact@v3
  #       with:
  #         name: nuget
  #         if-no-files-found: error
  #         retention-days: 7
  #         path: |
  #           ${{ env.NuGetDirectory }}/*.nupkg
  #           ${{ env.NuGetDirectory }}/*.snupkg

  # push_nuget:
  #   runs-on: ubuntu-latest
  #   needs: [ build-and-publish ]
  #   steps:
  #      # Download the NuGet package created in the previous job
  #     - uses: actions/download-artifact@v3
  #       with:
  #         name: nuget
  #         path: ${{ env.NuGetDirectory }}
      
  #     # Install the .NET SDK indicated in the global.json file
  #     - name: Setup .NET Core
  #       uses: actions/setup-dotnet@v3

  #     # Publish all NuGet packages to NuGet.org
  #     # Use --skip-duplicate to prevent errors if a package with the same version already exists.
  #     # If you retry a failed workflow, already published packages will be skipped without error.
  #     - name: Publish NuGet package
  #       run: |
  #         foreach($file in (Get-ChildItem "${{ env.NuGetDirectory }}" -Recurse -Include *.nupkg)) {
  #             dotnet nuget push $file --api-key "${{ secrets.GITHUB_TOKEN }}" --source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json --skip-duplicate
  #         }
